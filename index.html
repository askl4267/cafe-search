<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OSAKA CAFE FINDER</title>

  <!-- Google Fonts：本文は丸めの日本語サンセリフ、見出しはクラシックなセリフ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Shippori+Mincho:wght@600;700&display=swap" rel="stylesheet">

  <style>
    /* 紙のような質感（ノイズ＋グラデ） */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(167,127,87,.08), transparent 60%),
        radial-gradient(1000px 600px at 120% 10%, rgba(122,160,136,.06), transparent 60%),
        linear-gradient(180deg, #fff8ee, #fff1db 85%);
      z-index:-2;
    }
    body::after{
      /* 細かい紙ノイズ */
      content:""; position:fixed; inset:0; z-index:-1; opacity:.25; pointer-events:none;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity=".06"/></svg>');
      background-size: 220px 220px;
      mix-blend-mode:multiply;
    }
    .thumb { aspect-ratio: 4 / 3; object-fit: cover; }
    .skeleton { background: linear-gradient(90deg,#f1e6d9 25%,#fff3e3 37%,#f1e6d9 63%); background-size:400% 100%; animation:shimmer 1.1s infinite; border-radius:16px }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }
  </style>
  <link rel="stylesheet" href="/styles.css">
</head>

<body class="text-coffee-900 font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-cream-100/80 backdrop-blur border-b border-coffee-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-coffee-600"></div>
        <div class="font-display text-2xl tracking-wide">Osaka Cafe Finder</div>
      </div>
      <div id="headerSummary" class="ml-4 text-sm text-coffee-600 hidden md:block"></div>
      <div class="ml-auto text-xs text-coffee-500">Powered by Hot Pepper</div>
    </div>
  </header>

  <!-- Hero -->
<section class="border-b border-coffee-100">
  <div class="max-w-7xl mx-auto px-4 py-8 sm:py-12">
    <h1 class="font-display text-3xl sm:text-4xl text-coffee-800">今日はどんなカフェ気分？</h1>
    <p class="text-coffee-700/80 mt-2">エリア・駐車・禁煙で絞って、雰囲気の合うお店を見つけよう。</p>

    <!-- Filter card（検索フォームは必ずこのコンテナの中に置く） -->
    <div class="mt-6 bg-cream-50/70 border border-coffee-200 rounded-2xl shadow-card p-4 sm:p-6">

      <!-- ▼ エリア選択（中→小ツリー） -->
      <section class="bg-cream-100/60 border border-cream-200 rounded-2xl p-4">
        <h3 class="text-coffee-800 font-semibold mb-2">エリア</h3>

        <!-- 中エリア（横並びチップ） -->
        <div id="midChips" class="flex flex-wrap gap-2 mb-3"></div>

        <!-- 小エリア（中エリア未選択のときは非表示） -->
        <div id="smallWrapper" class="space-y-3 hidden">
          <div class="text-sm text-coffee-700 font-semibold">小エリア</div>
          <div id="smallPanels" class="space-y-3"></div>
        </div>

        <!-- ハード条件 -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm text-coffee-700">駐車</span>
            <select id="parking" class="w-full rounded-xl border border-cream-300 bg-white p-2">
              <option value="any">指定なし</option>
              <option value="has">あり</option>
              <option value="none">なし</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm text-coffee-700">禁煙</span>
            <select id="smoking" class="w-full rounded-xl border border-cream-300 bg-white p-2">
              <option value="any">指定なし</option>
              <option value="non_smoking">全面禁煙</option>
              <option value="has_non_smoking">禁煙席あり</option>
            </select>
          </label>
          <div class="flex items-end">
            <button id="search" class="w-full bg-coffee-600 hover:bg-coffee-700 text-white rounded-xl py-2">
              検索する
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>
</section>


<!-- ▼ ページャ + 件数（同じ高さのバー） -->
<!--
<section class="max-w-7xl mx-auto px-4 mt-6">
  <div id="toolbar" class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <button id="prev"
        class="px-3 py-2 rounded-xl border border-coffee-200 text-coffee-800 hover:bg-cream-200/60 disabled:opacity-40"
        disabled>← 前へ</button>
      <span id="pageInfo" class="text-sm text-coffee-700">1 / 1</span>
      <button id="next"
        class="px-3 py-2 rounded-xl border border-coffee-200 text-coffee-800 hover:bg-cream-200/60 disabled:opacity-40">
        次へ →
      </button>
    </div>
    <p id="summary" class="text-sm text-coffee-700/80">該当: 0 件</p>
  </div>
-->
<section class="max-w-7xl mx-auto px-4 mt-6">
  <!-- ▼ 件数（上部に表示） -->
  <p id="summaryTop" class="text-sm text-coffee-700/80 mb-2">該当: 0 件</p>

  <!-- ▼ カード -->
  <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

  <!-- ▼ ページャ（下部） -->
  <nav id="pager" class="mt-6 flex items-center justify-center gap-2"></nav>
</section>


<script>
(() => {
  // ★あなたの Worker（末尾スラなし）
  const API_BASE = "%API_BASE%";

  // ---- state -------------------------------------------------------------
  let currentPage = 1;
  /** 全エリアのマスタ {code,name} */
  let middleMaster = [];  // 中エリア
  let smallMaster  = [];  // 小エリア
  /** 選択中 */
  const midsSelected  = new Set();  // 中エリア（チップ）
  const smallSelected = new Set();  // 小エリア（チェック）

  // ---- utilities ---------------------------------------------------------
  const el  = (sel) => document.querySelector(sel);
  const els = (sel) => Array.from(document.querySelectorAll(sel));

  function setLoading() {
    const grid = el('#cards');
    grid.innerHTML = '';
    for (let i = 0; i < 6; i++) {
      const sk = document.createElement('div');
      sk.className = 'skeleton h-[220px] rounded-2xl';
      grid.appendChild(sk);
    }
  }

  /** 件数APIを叩いて {middle: Map, small: Map} を返す */
  async function fetchAreaCounts() {
    const parking = el('#parking').value;     // has/none/any
    const smoking = el('#smoking').value;     // non_smoking/has_non_smoking/any
    const qs = new URLSearchParams({ parking, smoking });
    if (midsSelected.size) qs.set('middle', Array.from(midsSelected).join(','));

    const r = await fetch(`${API_BASE}/area_counts?${qs}`);
    if (!r.ok) throw new Error(`/area_counts ${r.status}`);
    const j = await r.json();
    return {
      midMap:   new Map((j.middle||[]).map(({code,cnt}) => [code, cnt])),
      smallMap: new Map((j.small ||[]).map(({code,cnt}) => [code, cnt])),
    };
  }

  // ---- renderers ---------------------------------------------------------
  async function renderMidChips() {
    const { midMap } = await fetchAreaCounts();
    const box = el('#midChips');
    box.innerHTML = '';

    middleMaster.forEach(m => {
      const n = midMap.get(m.code) || 0;
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className =
        'px-3 py-1.5 rounded-full border text-sm transition ' +
        (midsSelected.has(m.code)
          ? 'bg-coffee-700 text-white border-coffee-700'
          : 'border-coffee-200 text-coffee-800 hover:bg-cream-200/60');
      chip.textContent = n ? `${m.name}（${n}）` : m.name;
      chip.dataset.code = m.code;
      chip.addEventListener('click', async () => {
        if (midsSelected.has(m.code)) midsSelected.delete(m.code);
        else midsSelected.add(m.code);
        await renderMidChips();     // 自分の見た目＆件数更新
        await renderSmallPanels();  // 小エリア再生成
      });
      box.appendChild(chip);
    });
  }

  async function renderSmallPanels() {
    const smallWrapper = el('#smallWrapper');
    const wrap = el('#smallPanels');

    // 中エリア未選択 → 完全に隠す
    if (!midsSelected.size) {
      if (wrap) wrap.innerHTML = '';
      if (smallWrapper) smallWrapper.classList.add('hidden');
      return;
    }

    // 以降は表示
    if (smallWrapper) smallWrapper.classList.remove('hidden');

    const { smallMap } = await fetchAreaCounts();
    wrap.innerHTML = '';

    // 件数>0 の小エリアのみ
    const candidates = smallMaster.filter(s => (smallMap.get(s.code) || 0) > 0);

    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2';

    candidates
      .sort((a,b)=>a.name.localeCompare(b.name,'ja'))
      .forEach(s => {
        const n = smallMap.get(s.code) || 0;
        const id = `sm-${s.code}`;
        const label = document.createElement('label');
        label.className = 'flex items-center gap-2 rounded-xl border border-cream-300 bg-white px-3 py-2';
        label.innerHTML = `
          <input id="${id}" type="checkbox" class="rounded" ${smallSelected.has(s.code)?'checked':''}>
          <span class="text-sm">${n ? `${s.name}（${n}）` : s.name}</span>
        `;
        label.querySelector('input').addEventListener('change', (e) => {
          if (e.target.checked) smallSelected.add(s.code);
          else smallSelected.delete(s.code);
        });
        grid.appendChild(label);
      });

    if (!candidates.length) {
      const p = document.createElement('p');
      p.className = 'text-sm text-coffee-600';
      p.textContent = '選択中の条件に合う小エリアはありません。';
      wrap.appendChild(p);
    } else {
      wrap.appendChild(grid);
    }
  }

  function renderPager({ page, total_pages }) {
  const nav = document.getElementById('pager');
  nav.innerHTML = '';

  const makeBtn = (label, disabled, onClick, active = false, asDots = false) => {
    const el = document.createElement(asDots ? 'span' : 'button');
    el.textContent = label;
    if (asDots) {
      el.className = 'px-2 text-coffee-500';
    } else {
      el.type = 'button';
      el.disabled = !!disabled;
      el.className =
        'h-10 min-w-10 px-3 rounded-xl border transition ' +
        (active
          ? 'bg-coffee-800 text-white border-coffee-800'
          : 'bg-white text-coffee-800 border-coffee-200 hover:bg-cream-200/60 disabled:opacity-40');
      if (onClick) el.addEventListener('click', onClick);
    }
    nav.appendChild(el);
  };

  // 前へ
  makeBtn('前へ', page <= 1, () => run(page - 1));

  // 表示するページ集合を作成（1 / … / 近傍 / … / 最後）
  const pages = new Set();
  pages.add(1);
  const start = Math.max(2, page - 2);
  const end   = Math.min(total_pages - 1, page + 2);
  for (let p = start; p <= end; p++) pages.add(p);
  if (total_pages > 1) pages.add(total_pages);

  const list = [...pages].sort((a, b) => a - b);

  // 省略記号を差し込みながらボタン描画
  for (let i = 0; i < list.length; i++) {
    const p = list[i];
    if (i > 0 && list[i - 1] !== p - 1) {
      makeBtn('…', true, null, false, true);
    }
    makeBtn(String(p), false, () => run(p), p === page);
  }

  // 次へ
  makeBtn('次へ', page >= total_pages, () => run(page + 1));

  // 「x/総ページ」を1つだけ描画・更新
  let info = document.getElementById('pageInfoBottom');
  if (!info) {
    info = document.createElement('div');
    info.id = 'pageInfoBottom';
    info.className = 'w-full text-center text-sm text-coffee-600 mt-2';
    nav.after(info);
  }
  info.textContent = `${page}/${total_pages}ページ`;
}


  // ---- search & paginate -------------------------------------------------
  async function run(page = 1) {
    currentPage = page;
    setLoading();

    const parking = el('#parking').value;
    const smoking = el('#smoking').value;

    const q = new URLSearchParams({
      page: String(currentPage),
      parking, smoking,
    });
    if (midsSelected.size)  q.set('middle', Array.from(midsSelected).join(','));
    if (smallSelected.size) q.set('small',  Array.from(smallSelected).join(','));

    const r = await fetch(`${API_BASE}/search?${q}`);
    if (!r.ok) throw new Error(`/search ${r.status}`);
    const j = await r.json();

    // 件数（上）＋ 右上の簡易件数（使っていれば）
[document.getElementById('summaryTop'), document.getElementById('headerSummary')]
  .filter(Boolean)
  .forEach(el => {
    el.textContent = `該当: ${j.total} 件（${j.page} / ${j.total_pages}）`;
  });

// ページャ
renderPager({ page: j.page, total_pages: j.total_pages });

    // カード
    const grid = el('#cards'); grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    (j.items || []).forEach(s => {
      const card = document.createElement('article');
      card.className = 'bg-cream-100 rounded-2xl shadow-card overflow-hidden flex flex-col h-full';
      const img = s.photo_l || 'https://placehold.co/600x450?text=Cafe';
      card.innerHTML = `
        <img src="${img}" alt="" class="w-full aspect-4-3 thumb">
        <div class="p-4 flex flex-col gap-2 grow">
          <h3 class="font-semibold text-coffee-800 line-clamp-2 min-h-[2.5rem]">${s.name}</h3>
          <p class="text-sm text-coffee-700 line-clamp-2 min-h-[2.5rem]">${s.address||''}</p>
          <p class="text-xs text-coffee-600">禁煙: ${s.non_smoking||'不明'} ／ Wi-Fi: ${s.wifi||'不明'} ／ 駐車: ${s.parking||'不明'}</p>
          <div class="mt-auto pt-2">
          <a href="/detail.html?id=${encodeURIComponent(s.id)}"
              class="inline-flex items-center gap-1 text-sm text-coffee-800 bg-white border border-coffee-200 hover:bg-cream-200/60 px-3 py-1.5 rounded-lg">
              詳細を見る
          </a>
          </div>
        </div>`;
      frag.appendChild(card);
    });
    grid.appendChild(frag);
  }

  // ---- boot --------------------------------------------------------------
  el('#search').addEventListener('click', () => run(1));
  el('#parking').addEventListener('change', async () => { await renderMidChips(); await renderSmallPanels(); });
  el('#smoking').addEventListener('change', async () => { await renderMidChips(); await renderSmallPanels(); });

  (async () => {
    // マスタ取得
    const areas = await (await fetch(`${API_BASE}/areas`)).json();
    middleMaster = (areas.middle || []);
    smallMaster  = (areas.small  || []);
    // 初期レンダリング
    await renderMidChips();
    await renderSmallPanels();
    // 初回検索
    run(1);
  })();
})();
</script>

</body>
</html>
